<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Bot Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
        }

        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            flex: 1;
            min-height: 200px;
            max-height: calc(100vh - 380px);
        }

        #youtube-player {
            width: 100%;
            height: 100%;
        }

        .player-controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            flex-shrink: 0;
        }

        .now-playing-info {
            text-align: center;
            margin-bottom: 10px;
        }

        .song-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .song-info {
            font-size: 14px;
            color: #888;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .control-btn.play {
            width: 60px;
            height: 60px;
            background: #1db954;
        }

        .control-btn.play:hover {
            background: #1ed760;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .settings-section {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }

        .default-video-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            flex: 1;
        }

        .default-video-section h3 {
            font-size: 13px;
            color: #888;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 13px;
            min-width: 0;
        }

        .input-group input::placeholder {
            color: #666;
        }

        .input-group button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #1db954;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        .input-group button:hover {
            background: #1ed760;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .playlist {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .playlist-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .playlist-header span {
            color: #888;
            font-weight: normal;
        }

        .playlist-items {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .playlist-item-info {
            flex: 1;
            overflow: hidden;
        }

        .playlist-item-title {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-meta {
            font-size: 12px;
            color: #888;
        }

        .playlist-item-delete {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .playlist-item:hover .playlist-item-delete {
            opacity: 1;
        }

        .playlist-item-delete:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        .empty-playlist {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .right-panel {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Music Bot Player</h1>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ì—°ê²° ì¤‘...</span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="video-container">
                    <div id="youtube-player"></div>
                </div>

                <div class="player-controls">
                    <div class="now-playing-info">
                        <div class="song-title" id="currentTitle">ì¬ìƒ ì¤‘ì¸ ê³¡ ì—†ìŒ</div>
                        <div class="song-info" id="currentInfo">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ê³¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
                    </div>

                    <div class="controls">
                        <button class="control-btn" onclick="previous()">â®</button>
                        <button class="control-btn play" id="playBtn" onclick="togglePlay()">â–¶</button>
                        <button class="control-btn" onclick="next()">â­</button>
                    </div>

                    <div class="volume-control">
                        <span>ğŸ”ˆ</span>
                        <input type="range" class="volume-slider" id="volumeSlider"
                               min="0" max="100" th:value="${state.volume}" onchange="setVolume(this.value)">
                        <span>ğŸ”Š</span>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="default-video-section">
                        <h3>ê¸°ë³¸ ì˜ìƒ</h3>
                        <div class="input-group">
                            <input type="text" id="defaultVideoUrl" placeholder="YouTube URL"
                                   th:value="${state.defaultVideoUrl}">
                            <button onclick="setDefaultVideo()">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="playlist">
                    <div class="playlist-header">
                        í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ <span>(<span id="songCount" th:text="${#lists.size(songs)}">0</span>ê³¡)</span>
                    </div>
                    <div id="playlistContainer" class="playlist-items">
                        <div th:if="${#lists.isEmpty(songs)}" class="empty-playlist">
                            í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.<br>
                            ìŠ¬ë™ì—ì„œ /music add ëª…ë ¹ì–´ë¡œ ê³¡ì„ ì¶”ê°€í•˜ì„¸ìš”.
                        </div>
                        <div th:each="song : ${songs}" class="playlist-item" th:data-video-id="${song.videoId}" th:data-song-id="${song.id}">
                            <img th:src="${song.thumbnailUrl}" alt="thumbnail">
                            <div class="playlist-item-info">
                                <div class="playlist-item-title" th:text="${song.title}">Song Title</div>
                                <div class="playlist-item-meta" th:text="${song.addedBy}">Added by</div>
                            </div>
                            <button class="playlist-item-delete" th:onclick="'deleteSong(' + ${song.id} + ')'" title="ì‚­ì œ">âœ•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let player;
        let ws;
        let isPlaying = false;
        let currentVideoId = null;
        let lastSyncTime = Date.now();
        let syncInterval = null;
        let lastKnownSongCount = 0;

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'mute': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube Player Ready');
            connectWebSocket();
            autoPlayOnLoad();

            document.body.addEventListener('click', function() {
                if (player && player.isMuted && player.isMuted()) {
                    player.unMute();
                    player.setVolume(document.getElementById('volumeSlider').value);
                }
            }, { once: true });
        }

        function autoPlayOnLoad() {
            // ì´ˆê¸° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê³¡ ìˆ˜ ì €ì¥
            fetch('/api/songs')
                .then(response => response.json())
                .then(songs => {
                    lastKnownSongCount = songs.length;
                });

            fetch('/api/player/state')
                .then(response => response.json())
                .then(state => {
                    console.log('Player state:', state);
                    document.getElementById('volumeSlider').value = state.volume;

                    let videoIdToPlay = null;
                    let title = 'ê¸°ë³¸ ì˜ìƒ';
                    let info = 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤';

                    if (state.currentSong) {
                        videoIdToPlay = state.currentSong.videoId;
                        title = state.currentSong.title;
                        info = 'Added by ' + state.currentSong.addedBy;
                    } else if (state.remainingSongs > 0) {
                        fetch('/api/player/next', { method: 'POST' })
                            .then(r => r.json())
                            .then(newState => {
                                if (newState.currentSong) {
                                    player.loadVideoById(newState.currentSong.videoId);
                                    updateNowPlaying(newState.currentSong);
                                    isPlaying = true;
                                    updatePlayButton();
                                }
                            });
                        return;
                    } else if (state.defaultVideoUrl) {
                        videoIdToPlay = extractVideoId(state.defaultVideoUrl);
                    }

                    if (videoIdToPlay) {
                        console.log('Playing video:', videoIdToPlay);
                        player.loadVideoById(videoIdToPlay);
                        currentVideoId = videoIdToPlay;
                        isPlaying = true;
                        updatePlayButton();
                        document.getElementById('currentTitle').textContent = title;
                        document.getElementById('currentInfo').textContent = info;
                    }
                })
                .catch(err => console.error('Error loading state:', err));
        }

        function extractVideoId(url) {
            if (!url) return null;
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        }

        function updateNowPlaying(song) {
            if (song) {
                document.getElementById('currentTitle').textContent = song.title;
                document.getElementById('currentInfo').textContent = 'Added by ' + song.addedBy;
            } else {
                document.getElementById('currentTitle').textContent = 'ì¬ìƒ ì¤‘ì¸ ê³¡ ì—†ìŒ';
                document.getElementById('currentInfo').textContent = 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ê³¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”';
            }
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                fetch('/api/player/next', { method: 'POST' })
                    .then(response => response.json())
                    .then(state => {
                        if (state.currentSong) {
                            updateNowPlaying(state.currentSong);
                        } else {
                            updateNowPlaying(null);
                        }
                        refreshPlaylist();
                    });
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/player`);

            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'ì—°ê²°ë¨';
                lastSyncTime = Date.now();
                startPollingFallback();
            };

            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'ì—°ê²° ëŠê¹€';
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = () => {
                syncPlaylistState();
            };

            ws.onmessage = (event) => {
                lastSyncTime = Date.now();
                const data = JSON.parse(event.data);
                handleCommand(data.command, data.data);
            };
        }

        function startPollingFallback() {
            if (syncInterval) clearInterval(syncInterval);

            // 30ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸ (WebSocket ëª…ë ¹ì„ ëª» ë°›ì•˜ì„ ê²½ìš° ëŒ€ë¹„)
            syncInterval = setInterval(() => {
                const timeSinceLastSync = Date.now() - lastSyncTime;

                // 45ì´ˆ ì´ìƒ WebSocket ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ë™ê¸°í™”
                if (timeSinceLastSync > 45000) {
                    syncPlaylistState();
                }
            }, 30000);
        }

        function syncPlaylistState() {
            // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë™ê¸°í™”
            fetch('/api/songs')
                .then(response => response.json())
                .then(songs => {
                    const newCount = songs.length;

                    // ê³¡ ìˆ˜ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ UI ì—…ë°ì´íŠ¸
                    if (newCount !== lastKnownSongCount) {
                        lastKnownSongCount = newCount;
                        updatePlaylistUI(songs);
                        fetchAndUpdateNowPlaying();
                    }
                })
                .catch(() => {});
        }

        function updatePlaylistUI(songs) {
            const container = document.getElementById('playlistContainer');
            document.getElementById('songCount').textContent = songs.length;

            if (songs.length === 0) {
                container.innerHTML = `
                    <div class="empty-playlist">
                        í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.<br>
                        ìŠ¬ë™ì—ì„œ /music add ëª…ë ¹ì–´ë¡œ ê³¡ì„ ì¶”ê°€í•˜ì„¸ìš”.
                    </div>
                `;
            } else {
                container.innerHTML = songs.map(song => `
                    <div class="playlist-item" data-video-id="${song.videoId}" data-song-id="${song.id}">
                        <img src="${song.thumbnailUrl}" alt="thumbnail">
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title}</div>
                            <div class="playlist-item-meta">${song.addedBy}</div>
                        </div>
                        <button class="playlist-item-delete" onclick="deleteSong(${song.id})" title="ì‚­ì œ">âœ•</button>
                    </div>
                `).join('');
            }
        }

        function handleCommand(command, data) {
            switch (command) {
                case 'ping':
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ command: 'pong', data: data }));
                    }
                    break;
                case 'play':
                    if (data) {
                        player.loadVideoById(data);
                        currentVideoId = data;
                    } else {
                        player.playVideo();
                    }
                    isPlaying = true;
                    updatePlayButton();
                    fetchAndUpdateNowPlaying();
                    break;
                case 'pause':
                    player.pauseVideo();
                    isPlaying = false;
                    updatePlayButton();
                    break;
                case 'playDefault':
                    if (data) {
                        player.loadVideoById(data);
                        currentVideoId = data;
                    }
                    isPlaying = true;
                    updatePlayButton();
                    updateNowPlaying(null);
                    break;
                case 'volume':
                    player.setVolume(parseInt(data));
                    document.getElementById('volumeSlider').value = data;
                    break;
                case 'restart':
                    player.seekTo(0);
                    player.playVideo();
                    break;
                case 'playlistUpdated':
                    refreshPlaylist();
                    fetchAndUpdateNowPlaying();
                    break;
            }
        }

        function fetchAndUpdateNowPlaying() {
            fetch('/api/player/state')
                .then(response => response.json())
                .then(state => {
                    if (state.currentSong) {
                        updateNowPlaying(state.currentSong);
                    } else {
                        updateNowPlaying(null);
                    }
                });
        }

        function refreshPlaylist() {
            fetch('/api/songs')
                .then(response => response.json())
                .then(songs => {
                    lastKnownSongCount = songs.length;
                    updatePlaylistUI(songs);
                });
        }

        function togglePlay() {
            if (isPlaying) {
                fetch('/api/player/pause', { method: 'POST' });
            } else {
                fetch('/api/player/play', { method: 'POST' });
            }
        }

        function next() {
            fetch('/api/player/next', { method: 'POST' })
                .then(response => response.json())
                .then(state => {
                    if (state.currentSong) {
                        updateNowPlaying(state.currentSong);
                    } else {
                        updateNowPlaying(null);
                    }
                    refreshPlaylist();
                });
        }

        function previous() {
            fetch('/api/player/previous', { method: 'POST' });
        }

        function setVolume(value) {
            fetch('/api/player/volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ volume: parseInt(value) })
            });
        }

        function setDefaultVideo() {
            const url = document.getElementById('defaultVideoUrl').value;
            if (!url) {
                alert('YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            fetch('/api/player/default-video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ youtubeUrl: url })
            })
            .then(response => {
                if (response.ok) {
                    alert('ê¸°ë³¸ ì˜ìƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        function deleteSong(songId) {
            fetch(`/api/songs/${songId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        refreshPlaylist();
                        return null;
                    } else {
                        throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                    }
                })
                .then(state => {
                    if (state) {
                        refreshPlaylist();
                        if (state.currentSong) {
                            updateNowPlaying(state.currentSong);
                        } else {
                            updateNowPlaying(null);
                        }
                    }
                })
                .catch(err => {
                    alert('ê³¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function updatePlayButton() {
            const btn = document.getElementById('playBtn');
            btn.textContent = isPlaying ? 'â¸' : 'â–¶';
        }
    </script>
</body>
</html>
